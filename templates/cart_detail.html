{% extends 'base.html' %}

{% block content %}


{% if messages %}
    {% for message in messages %}
        <p style="color:red;">{{ message }}</p>
    {% endfor %}
{% endif %}


<h2>Your Shopping Cart</h2>

{% if items %}
<table border="1" cellpadding="10">
    <tr>
        <th>Product</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Total</th>
        <th>Action</th>
    </tr>


    <!-- {% for item in items %}
    <tr>
        <td>{{ item.product.name }}</td>
        <td>{{ item.quantity }}</td>
        <td>${{ item.product.price }}</td>
        <td>${{ item.total_price }}</td>
        <td>
            <a href="{% url 'remove_from_cart' item.id %}">Remove</a>
        </td>
    </tr>
    {% endfor %} -->



    


{% for item in items %}
<tr>
    <td>{{ item.product.name }}</td>
    <td>

        <form action="{% url 'update_cart_quantity' item.id %}" method="post" style="display:inline-block;">
            {% csrf_token %}
            
        <input 
    type="number"
    value="{{ item.quantity }}"
    min="1"
    max="{{ item.product.stock }}"
    data-item-id="{{ item.id }}"
    class="qty-input"
    style="width:60px;">
        </form>

    </td>
    <td>${{ item.product.price }}</td>
    <td>${{ item.total_price }}</td>
    <td>
        <a href="{% url 'remove_from_cart' item.id %}">Remove</a>
    </td>
</tr>
{% endfor %}



</table>
<p><strong>Total:</strong> ${{ total }}</p>
<a href="{% url 'checkout' %}" style="display:inline-block; padding:10px 20px; background:#28a745; color:white; text-decoration:none; border-radius:5px;">
    Proceed to Checkout
</a>
{% else %}
<p>Your cart is empty.</p>
{% endif %}


<script>
document.querySelectorAll('.qty-input').forEach(input => {
    input.addEventListener('change', function () {
        const itemId = this.dataset.itemId;
        const quantity = this.value;

        fetch(`/cart/update/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `quantity=${quantity}`
        })
        .then(() => {
            location.reload(); // simple + reliable for now
        });
    });
});
</script>


{% endblock %}






